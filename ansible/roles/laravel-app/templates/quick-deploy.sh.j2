#!/bin/bash
# Script de dÃ©ploiement rapide Laravel
# GÃ©nÃ©rÃ© par Ansible pour {{ app_project_name }}

set -e

PROJECT_NAME="{{ app_project_name }}"
PROJECT_PATH="{{ app_deploy_path }}"
GIT_REPO="{{ app_git_repo }}"
GIT_BRANCH="{{ app_git_branch | default('main') }}"
ENVIRONMENT="{{ laravel_env }}"

echo "ğŸš€ DÃ©ploiement rapide de {{ app_project_name }}"
echo "=====================================."

# Fonction pour afficher les messages
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

# Fonction pour vÃ©rifier les prÃ©requis
check_prerequisites() {
    log "VÃ©rification des prÃ©requis..."
    
    if ! command -v docker &> /dev/null; then
        log "âŒ Docker n'est pas installÃ©"
        exit 1
    fi
    
    if ! command -v docker-compose &> /dev/null; then
        log "âŒ Docker Compose n'est pas installÃ©"
        exit 1
    fi
    
    if ! command -v git &> /dev/null; then
        log "âŒ Git n'est pas installÃ©"
        exit 1
    fi
    
    log "âœ… PrÃ©requis vÃ©rifiÃ©s"
}

# Fonction pour mettre Ã  jour le code
update_code() {
    log "Mise Ã  jour du code depuis Git..."
    cd "$PROJECT_PATH"
    
    # Sauvegarder les changements locaux
    git stash push -m "Ansible deployment $(date)"
    
    # Mettre Ã  jour le code
    git fetch origin
    git checkout "$GIT_BRANCH"
    git pull origin "$GIT_BRANCH"
    
    log "âœ… Code mis Ã  jour"
}

# Fonction pour construire les conteneurs
build_containers() {
    log "Construction des conteneurs Docker..."
    cd "$PROJECT_PATH"
    
    # ArrÃªter les conteneurs existants
    docker-compose down || true
    
    # Construire et dÃ©marrer les conteneurs
    docker-compose up -d --build
    
    log "âœ… Conteneurs construits et dÃ©marrÃ©s"
}

# Fonction pour installer les dÃ©pendances
install_dependencies() {
    log "Installation des dÃ©pendances..."
    cd "$PROJECT_PATH"
    
    # Attendre que les conteneurs soient prÃªts
    sleep 30
    
    # Installer les dÃ©pendances Composer
    if [ "$ENVIRONMENT" == "production" ]; then
        docker-compose exec -T php composer install --no-dev --optimize-autoloader
    else
        docker-compose exec -T php composer install
    fi
    
    # Installer les dÃ©pendances Node.js
    docker-compose exec -T node npm ci
    
    log "âœ… DÃ©pendances installÃ©es"
}

# Fonction pour configurer Laravel
configure_laravel() {
    log "Configuration de Laravel..."
    cd "$PROJECT_PATH"
    
    # GÃ©nÃ©rer la clÃ© d'application
    docker-compose exec -T php php artisan key:generate --force
    
    # ExÃ©cuter les migrations
    docker-compose exec -T php php artisan migrate --force
    
    # Optimisations pour la production
    if [ "$ENVIRONMENT" == "production" ]; then
        docker-compose exec -T php php artisan config:cache
        docker-compose exec -T php php artisan route:cache
        docker-compose exec -T php php artisan view:cache
        docker-compose exec -T php php artisan event:cache
        
        # Construire les assets
        docker-compose exec -T node npm run build
    else
        # Nettoyer les caches en dÃ©veloppement
        docker-compose exec -T php php artisan config:clear
        docker-compose exec -T php php artisan route:clear
        docker-compose exec -T php php artisan view:clear
        docker-compose exec -T php php artisan event:clear
        
        # Construire les assets pour le dÃ©veloppement
        docker-compose exec -T node npm run dev
    fi
    
    log "âœ… Laravel configurÃ©"
}

# Fonction pour vÃ©rifier l'Ã©tat des services
check_services() {
    log "VÃ©rification des services..."
    cd "$PROJECT_PATH"
    
    # VÃ©rifier l'Ã©tat des conteneurs
    docker-compose ps
    
    # Tester la connexion HTTP
    sleep 10
    if curl -f http://localhost:80 > /dev/null 2>&1; then
        log "âœ… Application accessible"
    else
        log "âš ï¸  Application non accessible, vÃ©rifiez les logs"
        docker-compose logs --tail=50
    fi
}

# Fonction pour afficher les informations utiles
show_info() {
    log "Informations utiles:"
    echo "  ğŸ“ Projet: $PROJECT_NAME"
    echo "  ğŸŒ URL: http://localhost"
    echo "  ğŸ“Š Logs: docker-compose logs -f"
    echo "  ğŸ”„ RedÃ©marrer: docker-compose restart"
    echo "  ğŸ›‘ ArrÃªter: docker-compose down"
    echo "  ğŸ“§ Mailhog: http://localhost:8025"
    echo "  ğŸ—„ï¸ Adminer: http://localhost:8080"
    echo "  ğŸ“Š Dozzle: http://localhost:9999"
}

# Fonction principale
main() {
    log "DÃ©but du dÃ©ploiement..."
    
    check_prerequisites
    update_code
    build_containers
    install_dependencies
    configure_laravel
    check_services
    show_info
    
    log "ğŸ‰ DÃ©ploiement terminÃ© avec succÃ¨s !"
}

# Gestion des arguments
case "${1:-}" in
    "update")
        update_code
        ;;
    "build")
        build_containers
        ;;
    "install")
        install_dependencies
        ;;
    "configure")
        configure_laravel
        ;;
    "check")
        check_services
        ;;
    "info")
        show_info
        ;;
    *)
        main
        ;;
esac