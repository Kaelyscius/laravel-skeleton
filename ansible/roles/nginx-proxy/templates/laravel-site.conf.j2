# Configuration Nginx pour Laravel
# Générée par Ansible pour {{ environment }}
# Domaine: {{ app_domain_name | default('laravel.local') }}

upstream laravel_backend {
    server 127.0.0.1:80;
    keepalive 32;
}

server {
    listen 80;
    server_name {{ app_domain_name | default('laravel.local') }};
    
    # Logs
    access_log /var/log/nginx/{{ app_domain_name | default('laravel.local') }}.access.log main;
    error_log /var/log/nginx/{{ app_domain_name | default('laravel.local') }}.error.log;
    
    # Security headers
    include /etc/nginx/snippets/security.conf;
    
    # Maintenance mode
    if (-f /var/www/html/maintenance.html) {
        return 503;
    }
    
    error_page 503 @maintenance;
    location @maintenance {
        root /var/www/html;
        rewrite ^(.*)$ /maintenance.html break;
    }
    
    # Rate limiting for login
    location ~* ^/(login|register|password) {
        limit_req zone=login burst=5 nodelay;
        proxy_pass http://laravel_backend;
        include /etc/nginx/snippets/proxy-params.conf;
    }
    
    # Rate limiting for API
    location ~* ^/api/ {
        limit_req zone=api burst=20 nodelay;
        proxy_pass http://laravel_backend;
        include /etc/nginx/snippets/proxy-params.conf;
    }
    
    # Static files with caching
    location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        limit_req zone=static burst=100 nodelay;
        include /etc/nginx/snippets/cache.conf;
        proxy_pass http://laravel_backend;
        include /etc/nginx/snippets/proxy-params.conf;
    }
    
    # Main location
    location / {
        proxy_pass http://laravel_backend;
        include /etc/nginx/snippets/proxy-params.conf;
    }
    
    # Health check
    location /health {
        access_log off;
        proxy_pass http://laravel_backend;
        include /etc/nginx/snippets/proxy-params.conf;
    }
    
    # Deny access to sensitive files
    location ~ /\.(env|htaccess|htpasswd|git) {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # Gzip compression
    include /etc/nginx/snippets/gzip.conf;
    
    {% if ssl.enabled | default(false) %}
    # SSL redirect
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name {{ app_domain_name | default('laravel.local') }};
    
    # SSL configuration
    include /etc/nginx/snippets/ssl-params.conf;
    
    # Logs
    access_log /var/log/nginx/{{ app_domain_name | default('laravel.local') }}.ssl.access.log main;
    error_log /var/log/nginx/{{ app_domain_name | default('laravel.local') }}.ssl.error.log;
    
    # Security headers
    include /etc/nginx/snippets/security.conf;
    
    # HSTS
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    
    # Maintenance mode
    if (-f /var/www/html/maintenance.html) {
        return 503;
    }
    
    error_page 503 @maintenance;
    location @maintenance {
        root /var/www/html;
        rewrite ^(.*)$ /maintenance.html break;
    }
    
    # Rate limiting for login
    location ~* ^/(login|register|password) {
        limit_req zone=login burst=5 nodelay;
        proxy_pass http://laravel_backend;
        include /etc/nginx/snippets/proxy-params.conf;
    }
    
    # Rate limiting for API
    location ~* ^/api/ {
        limit_req zone=api burst=20 nodelay;
        proxy_pass http://laravel_backend;
        include /etc/nginx/snippets/proxy-params.conf;
    }
    
    # Static files with caching
    location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        limit_req zone=static burst=100 nodelay;
        include /etc/nginx/snippets/cache.conf;
        proxy_pass http://laravel_backend;
        include /etc/nginx/snippets/proxy-params.conf;
    }
    
    # Main location
    location / {
        proxy_pass http://laravel_backend;
        include /etc/nginx/snippets/proxy-params.conf;
    }
    
    # Health check
    location /health {
        access_log off;
        proxy_pass http://laravel_backend;
        include /etc/nginx/snippets/proxy-params.conf;
    }
    
    # Deny access to sensitive files
    location ~ /\.(env|htaccess|htpasswd|git) {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # Gzip compression
    include /etc/nginx/snippets/gzip.conf;
    {% endif %}
}