# Configuration du VirtualHost SSL pour Laravel
# Note: Retirez "Listen 443" car il est déjà défini dans httpd.conf

<VirtualHost *:443>
   ServerName laravel.local
   ServerAlias www.laravel.local

   # Document Root
   DocumentRoot /var/www/html/public

   # SSL Configuration - CHEMINS CORRIGES
   SSLEngine on
   SSLCertificateFile /etc/apache2/ssl/laravel.local.crt
   SSLCertificateKeyFile /etc/apache2/ssl/laravel.local.key

   # Protocoles SSL/TLS sécurisés
   SSLProtocol -all +TLSv1.2 +TLSv1.3
   SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
   SSLHonorCipherOrder on

   # HTTP/2 (si le module est activé)
   <IfModule mod_http2.c>
       Protocols h2 http/1.1
   </IfModule>

   # Headers de sécurité (si le module headers est activé)
   <IfModule mod_headers.c>
       Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
       Header always set X-Frame-Options "SAMEORIGIN"
       Header always set X-Content-Type-Options "nosniff"
       Header always set X-XSS-Protection "1; mode=block"
       Header always set Referrer-Policy "strict-origin-when-cross-origin"
   </IfModule>

   # Configuration du Directory
   <Directory /var/www/html/public>
       Options -Indexes +FollowSymLinks
       AllowOverride All
       Require all granted

       # Configuration du .htaccess Laravel
       <IfModule mod_rewrite.c>
           RewriteEngine On
           RewriteCond %{REQUEST_FILENAME} !-d
           RewriteCond %{REQUEST_FILENAME} !-f
           RewriteRule ^ index.php [L]
       </IfModule>
   </Directory>

   # Configuration PHP-FPM via proxy
   <FilesMatch \.php$>
       SetHandler "proxy:fcgi://php:9000"
   </FilesMatch>

   # Gestion des index
   DirectoryIndex index.php index.html

   # Logs
   ErrorLog /usr/local/apache2/logs/laravel-error.log
   CustomLog /usr/local/apache2/logs/laravel-access.log combined

   # Compression Gzip
   <IfModule mod_deflate.c>
       AddOutputFilterByType DEFLATE text/plain
       AddOutputFilterByType DEFLATE text/html
       AddOutputFilterByType DEFLATE text/xml
       AddOutputFilterByType DEFLATE text/css
       AddOutputFilterByType DEFLATE application/xml
       AddOutputFilterByType DEFLATE application/xhtml+xml
       AddOutputFilterByType DEFLATE application/rss+xml
       AddOutputFilterByType DEFLATE application/javascript
       AddOutputFilterByType DEFLATE application/x-javascript
       AddOutputFilterByType DEFLATE application/json
   </IfModule>

   # Cache pour les assets statiques
   <IfModule mod_expires.c>
       ExpiresActive On
       ExpiresByType image/jpg "access plus 1 year"
       ExpiresByType image/jpeg "access plus 1 year"
       ExpiresByType image/gif "access plus 1 year"
       ExpiresByType image/png "access plus 1 year"
       ExpiresByType image/svg+xml "access plus 1 year"
       ExpiresByType text/css "access plus 1 month"
       ExpiresByType application/pdf "access plus 1 month"
       ExpiresByType text/javascript "access plus 1 month"
       ExpiresByType application/javascript "access plus 1 month"
       ExpiresByType application/x-javascript "access plus 1 month"
       ExpiresByType application/x-shockwave-flash "access plus 1 month"
       ExpiresByType image/x-icon "access plus 1 year"
       ExpiresDefault "access plus 2 days"
   </IfModule>
</VirtualHost>

# Redirection HTTP vers HTTPS
<VirtualHost *:80>
   ServerName laravel.local
   ServerAlias www.laravel.local
   Redirect permanent / https://laravel.local/
</VirtualHost>

# Configuration du healthcheck endpoint
<Location /health>
   <RequireAll>
       Require all granted
   </RequireAll>
   ProxyPass !
   SetHandler server-status
</Location>

# Configuration du server-status pour le monitoring
<Location /server-status>
   SetHandler server-status
   <RequireAny>
       Require ip 127.0.0.1
       Require ip ::1
       Require local
   </RequireAny>
</Location>